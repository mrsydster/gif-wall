<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="theme-color" content="#000000" />
        <meta name="Gif Viewer" content="Gif" />
        <title>Gif Viewer</title>
        <script src="//streamdoctors.com/tmi.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                text-align: center;
                color: white;
                background: gray;
                font-size: 100px;
            }
        </style>
    </head>
    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div id="wrapper">Gif here</div>
        <script>
            const { alert, tmi } = window;

            const urlParams = new URLSearchParams(window.location.search);

            // Check if URL contains clearcookies -> clear all cookies if true
            if (urlParams.get('clearcookies') !== null && confirm('Are you sure to delete cookies from Gif Shower and so all its data?')) {
                document.cookie.split(';').forEach((c) => {
                    document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
                });
            }

            // Function to read value of specific cookie
            const readCookie = (name) => {
                const nameEQ = `${name}=`;
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            };

            // Get parameters from url
            const username = urlParams.get('botusername'); // oauth:ncrzdqqnzaau9wyefofjzh0xtai7i1
            const oauth = urlParams.get('oauth'); // oauth:ncrzdqqnzaau9wyefofjzh0xtai7i1

            const channel =
                urlParams.get('channel') ||
                readCookie('twitch_channel') ||
                prompt(`Channel parameter is missing in URL (channel=xxxx)\n\nPlease enter the Twitch channel:`, 'twitch') ||
                'twitch'; // If no channel is filled > use twitch as channel

            // Set the channel cookie
            if (channel && channel !== 'twitch') document.cookie = `twitch_channel=${channel}`;

            // Tmi.js options
            const tmiOptions = {
                options: { debug: urlParams.get('debug') !== null },
                identity: {
                    username,
                    password: `oauth:${oauth}`,
                },
                channels: [channel],
            };

            // Check if username or oauth is missing.
            if (!username || !oauth) {
                if (readCookie('missing_oauth_message_shown') != 'true') {
                    alert(`Missing oauth parameters in URL (botusername=xxxx&oauth=xxxx)\n\nBot will not respond in chat!`);
                    document.cookie = `missing_oauth_message_shown=true`;
                }

                // Delete the identity so bot will only read chat
                delete tmiOptions.identity;
            }

            // Create tmi client
            const client = new tmi.Client(tmiOptions);

            // Create banlist
            let banList = JSON.parse(readCookie('ban_list') || '[]');

            // Function to send tmi message if able torespond.
            const sendTmiMessage = ({ channel, message }) => {
                if (!tmiOptions.identity.username) return;

                client.say(channel, message);
            };

            // Function to add user to banlist
            const addToBanList = ({ banUser, username }) => {
                if (banList.includes(banUser)) return sendTmiMessage({ channel, message: `@${username}: ${banUser} is already banned!` });

                banList.push(banUser);
                document.cookie = `ban_list=${JSON.stringify(banList)}`;

                return sendTmiMessage({ channel, message: `@${username}: ${banUser} is banned from posting gifs!` });
            };

            // Function to add user to banlist
            const removeFromBanList = ({ banUser, username }) => {
                if (!banList.includes(banUser)) return sendTmiMessage({ channel, message: `@${username}: ${banUser} is not banned!` });

                banList = banList.filter((e) => e !== banUser);
                document.cookie = `ban_list=${JSON.stringify(banList)}`;

                return sendTmiMessage({ channel, message: `@${username}: ${banUser} is unbanned!` });
            };

            // Function to handle commands from chat
            const handleCommand = ({ command, args, username }) => {
                // Handle new gif
                if (command === 'gif') {
                    switch (args[0]) {
                        case 'match giphy url':
                            if (args[1]) addToBanList({ banUser: args[1].startsWith('@') ? args[1].slice(1) : args[1], username });
                            else sendTmiMessage({ channel, message: `@${username} make sure to add the username` });
                            break;

                        case 'modonly':
                            if (args[1]) addToBanList({ banUser: args[1].startsWith('@') ? args[1].slice(1) : args[1], username });
                            else sendTmiMessage({ channel, message: `@${username} make sure to add the username` });
                            break;

                        case 'subonly':
                            if (args[1]) addToBanList({ banUser: args[1].startsWith('@') ? args[1].slice(1) : args[1], username });
                            else sendTmiMessage({ channel, message: `@${username} make sure to add the username` });
                            break;

                        case 'ban':
                            if (args[1]) addToBanList({ banUser: args[1].startsWith('@') ? args[1].slice(1) : args[1], username });
                            else sendTmiMessage({ channel, message: `@${username} make sure to add the username` });
                            break;

                        case 'unban':
                            if (args[1]) removeFromBanList({ banUser: args[1].startsWith('@') ? args[1].slice(1) : args[1], username });
                            else sendTmiMessage({ channel, message: `@${username} make sure to add the username` });
                            break;

                        default:
                            break;

                        // add sub only
                        // add mod only
                        // make sure mods can only run mod commands
                        // !gif check if user is banned and if it fits the mode it is in
                    }
                    //
                }
            };

            // Catch message
            client.on('message', (_, tags, message, self) => {
                // Ignore echoed messages.
                if (self || !message.startsWith('!')) return;

                const args = message.slice(1).toLowerCase().split(' ');
                const command = args.shift().toLowerCase();

                // Return if command is null or undefined
                if (!command) return;

                // Handle command
                handleCommand({ command, args, username: tags.username });
            });

            // Connect to tmi
            client.connect();

            document.getElementById('wrapper').innerHTML = channel;
        </script>
    </body>
</html>
